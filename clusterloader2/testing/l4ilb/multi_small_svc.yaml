# ASSUMPTIONS:
# - This test is designed for 100-node cluster.

#Constants
{{$POD_THROUGHPUT := DefaultParam .POD_THROUGHPUT 5}}
{{$POD_STARTUP_LATENCY_THRESHOLD := DefaultParam .POD_STARTUP_LATENCY_THRESHOLD "5s"}}
{{$OPERATION_TIMEOUT := DefaultParam .OPERATION_TIMEOUT "11m"}}

#Constants
{{$SMALL_BACKEND_SIZE := 10}}
{{$SMALL_BACKEND_SIZE_1:= 10}}
{{$SMALL_BACKEND_SIZE_2 := 10}}
{{$SMALL_BACKEND_SIZE_3 := 10}}
{{$SMALL_BACKEND_LABEL := "base"}}
{{$SMALL_BACKEND_LABEL_1 := "test_1"}}
{{$SMALL_BACKEND_LABEL_2 := "test_2"}}
{{$SMALL_BACKEND_LABEL_3 := "test_3"}}
{{$REPLICAS_NS := 20}}
# adding a fixed value for first version of the test, rate of pod creation not a concern yet.
{{$ilbQPS := 3}}
{{$namespaces := 25}}

#Test

name: small-svc
namespace:
  number: {{AddInt $namespaces 3}}
  
tuningSets:
- name: ILBConstantQPS
  qpsLoad:
    averageQps: {{$ilbQPS}}
- name: UniformQPS
  qpsLoad:
    qps: {{$POD_THROUGHPUT}}
  
steps:
- name: Start monitoring
  measurements:
  - Identifier: APIResponsivenessPrometheusSimple
    Method: APIResponsivenessPrometheus
    Params:
      action: start
  - Identifier: PodStartupLatency
    Method: PodStartupLatency
    Params:
      action: start
      labelSelector: group = ilb-load
      threshold: {{$POD_STARTUP_LATENCY_THRESHOLD}}
  - Identifier: WaitForRunningDeployments
    Method: WaitForControlledPodsRunning
    Params:
      action: start
      apiVersion: apps/v1
      kind: Deployment
      labelSelector: group = ilb-load
      operationTimeout: 120m

- name: Create deployment
  phases:
  - namespaceRange:
      min: 1
      max: {{$namespaces}}
    replicasPerNamespace: {{$REPLICAS_NS}}
    tuningSet: UniformQPS
    objectBundle:
    - basename: small-dep
      objectTemplatePath: dep.yaml
      templateFillMap:
        NumReplicas: {{$SMALL_BACKEND_SIZE}}

- name: Create deployment1
  phases:
  - namespaceRange:
      min: {{AddInt $namespaces 1}}
      max: {{AddInt $namespaces 1}}
    replicasPerNamespace: 10
    tuningSet: UniformQPS
    objectBundle:
    - basename: small-dep
      objectTemplatePath: dep.yaml
      templateFillMap:
        NumReplicas: {{$SMALL_BACKEND_SIZE_1}}

- name: Create deployment2
  phases:
  - namespaceRange:
      min: {{AddInt $namespaces 2}}
      max: {{AddInt $namespaces 2}}
    replicasPerNamespace: 10
    tuningSet: UniformQPS
    objectBundle:
    - basename: small-dep
      objectTemplatePath: dep.yaml
      templateFillMap:
        NumReplicas: {{$SMALL_BACKEND_SIZE_2}}

- name: Create deployment3
  phases:
  - namespaceRange:
      min: {{AddInt $namespaces 3}}
      max: {{AddInt $namespaces 3}}
    replicasPerNamespace: 10
    tuningSet: UniformQPS
    objectBundle:
    - basename: small-dep
      objectTemplatePath: dep.yaml
      templateFillMap:
        NumReplicas: {{$SMALL_BACKEND_SIZE_3}}

- name: Wait Pods Running
  measurements:
  - Identifier: WaitForRunningDeployments
    Method: WaitForControlledPodsRunning
    Params:
      action: gather


- name: Start base svc Monitor
  measurements:
  - Identifier: ServiceCreationLatencyBase
    Method: ServiceCreationLatency
    Params:
      action: start
      labelSelector: size = {{$SMALL_BACKEND_LABEL}}

- name: Create Base Service
  phases:
  - namespaceRange:
      min: 1
      max: {{$namespaces}}
    replicasPerNamespace: {{$REPLICAS_NS}}
    tuningSet: ILBConstantQPS
    objectBundle:
    - basename: small-dep-svc
      objectTemplatePath: service.yaml
      templateFillMap:
        DeploymentBaseName: small-dep
        ILBSizeLabel: {{$SMALL_BACKEND_LABEL}}

- name: Wait Service Ready
  measurements:
  - Identifier: ServiceCreationLatencyBase
    Method: ServiceCreationLatency
    Params:
      action: waitForReady


- name: Collect Data
  measurements:
  - Identifier: ServiceCreationLatencyBase
    Method: ServiceCreationLatency
    Params:
      action: gather

- name: Wait 3 min
  measurements:
  - Identifier: Wait
    Method: Sleep
    Params:
      duration: 3m

- name: Start 1st 10 Service Monitor
  measurements:
  - Identifier: ServiceCreationLatencyTest_1
    Method: ServiceCreationLatency
    Params:
      action: start
      labelSelector: size = {{$SMALL_BACKEND_LABEL_1}}


- name: Create 1st 10 Service
  phases:
  - namespaceRange:
      min: {{AddInt $namespaces 1}}
      max: {{AddInt $namespaces 1}}
    replicasPerNamespace: 10
    tuningSet: ILBConstantQPS
    objectBundle:
    - basename: small-dep-svc
      objectTemplatePath: service.yaml
      templateFillMap:
        DeploymentBaseName: small-dep
        ILBSizeLabel: {{$SMALL_BACKEND_LABEL_1}}

- name: Wait 1st 10 Service Ready
  measurements:
  - Identifier: ServiceCreationLatencyTest_1
    Method: ServiceCreationLatency
    Params:
      action: waitForReady

- name: Collect Data
  measurements:
  - Identifier: ServiceCreationLatencyTest_1
    Method: ServiceCreationLatency
    Params:
      action: gather

- name: Wait 3 min
  measurements:
  - Identifier: Wait
    Method: Sleep
    Params:
      duration: 3m

- name: Start 2nd 10 Service Monitor
  measurements:
  - Identifier: ServiceCreationLatencyTest_2
    Method: ServiceCreationLatency
    Params:
      action: start
      labelSelector: size = {{$SMALL_BACKEND_LABEL_2}}

- name: Create 2nd Service
  phases:
  - namespaceRange:
      min: {{AddInt $namespaces 2}}
      max: {{AddInt $namespaces 2}}
    replicasPerNamespace: 10
    tuningSet: ILBConstantQPS
    objectBundle:
    - basename: small-dep-svc
      objectTemplatePath: service.yaml
      templateFillMap:
        DeploymentBaseName: small-dep
        ILBSizeLabel: {{$SMALL_BACKEND_LABEL_2}}

- name: Wait 2nd Service Ready
  measurements:
  - Identifier: ServiceCreationLatencyTest_2
    Method: ServiceCreationLatency
    Params:
      action: waitForReady

- name: Collect Data
  measurements:
  - Identifier: ServiceCreationLatencyTest_2
    Method: ServiceCreationLatency
    Params:
      action: gather

- name: Wait 3 min
  measurements:
  - Identifier: Wait
    Method: Sleep
    Params:
      duration: 3m

- name: Start 3rd 10 Service Monitor
  measurements:
  - Identifier: ServiceCreationLatencyTest_3
    Method: ServiceCreationLatency
    Params:
      action: start
      labelSelector: size = {{$SMALL_BACKEND_LABEL_3}}

- name: Create 3rd 10 Service
  phases:
  - namespaceRange:
      min: {{AddInt $namespaces 3}}
      max: {{AddInt $namespaces 3}}
    replicasPerNamespace: 10
    tuningSet: ILBConstantQPS
    objectBundle:
    - basename: small-dep-svc
      objectTemplatePath: service.yaml
      templateFillMap:
        DeploymentBaseName: small-dep
        ILBSizeLabel: {{$SMALL_BACKEND_LABEL_3}}

- name: Wait 3rd 10 Service Ready
  measurements:
  - Identifier: ServiceCreationLatencyTest_3
    Method: ServiceCreationLatency
    Params:
      action: waitForReady

- name: Collect Data
  measurements:
  - Identifier: ServiceCreationLatencyTest_3
    Method: ServiceCreationLatency
    Params:
      action: gather

- name: Wait 3 min
  measurements:
  - Identifier: Wait
    Method: Sleep
    Params:
      duration: 3m    

- name: Delete Service
  phases:
  - namespaceRange:
      min: 1
      max: {{AddInt $namespaces 3}}
    replicasPerNamespace: 0
    tuningSet: ILBConstantQPS
    objectBundle:
    - basename: small-dep-svc
      objectTemplatePath: service.yaml

- name: Delete Deployment
  phases:
  - namespaceRange:
      min: 1
      max: {{AddInt $namespaces 3}}
    replicasPerNamespace: 0
    tuningSet: UniformQPS
    objectBundle:
    - basename: small-dep
      objectTemplatePath: dep.yaml
    
- name: Wait Pod Disappear
  measurements:
  - Identifier: WaitForRunningDeployments
    Method: WaitForControlledPodsRunning
    Params:
      action: gather

- name: Collect Data
  measurements:
  - Identifier: PodStartupLatency
    Method: PodStartupLatency
    Params:
      action: gather
  - Identifier: APIResponsivenessPrometheusSimple
    Method: APIResponsivenessPrometheus
    Params:
      action: gather
      enableViolations: true
      useSimpleLatencyQuery: true
      summaryName: APIResponsivenessPrometheus_simple
